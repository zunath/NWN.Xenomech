<UserControl xmlns="https://github.com/avaloniaui"
              xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
              xmlns:local="clr-namespace:XM.App.Editor.ViewModels"
              xmlns:views="clr-namespace:XM.App.Editor.Views"
              xmlns:converters="clr-namespace:XM.App.Editor.Converters"
              xmlns:sys="clr-namespace:System;assembly=netstandard"
              x:Class="XM.App.Editor.Views.ConversationEditorControl"
              x:DataType="local:ConversationEditorViewModel"
              x:Name="EditorControl">





    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250" MinWidth="150"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="300" MinWidth="200"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="*" MinWidth="200"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel - Conversation List -->
        <Border Grid.Column="0" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" BorderThickness="0,0,1,0">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top" Text="Conversations" FontWeight="Bold" Margin="10,5"/>
                
                <!-- Buttons -->
                <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="10,5">
                    <Button Command="{Binding CreateNewConversationCommand}" 
                            Margin="0,0,5,0"
                            Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="âž•" FontSize="12" Margin="0,0,5,0"/>
                            <TextBlock Text="New" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding DeleteConversationCommand}" 
                            Margin="0,0,5,0"
                            Padding="10,5">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ—‘ï¸" FontSize="12" Margin="0,0,5,0"/>
                            <TextBlock Text="Delete" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Conversation List -->
                <ListBox Name="ConversationListBox" 
                         ItemsSource="{Binding ConversationFiles}"
                         SelectedItem="{Binding SelectedConversationFile}"
                         Margin="10,5">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}" Margin="5"/>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>

        <!-- Resizable Panel 1 -->
        <GridSplitter Grid.Column="1" 
                       HorizontalAlignment="Stretch" 
                       Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       Width="5"/>

                 <!-- Middle Panel - Tree View -->
         <Border Grid.Column="2" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" BorderThickness="0,0,1,0">
             <DockPanel>
                 <!-- Conversation Details -->
                 <Border DockPanel.Dock="Top" 
                         BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                         BorderThickness="0,0,0,1" 
                         Margin="10,5" 
                         Padding="10"
                         IsVisible="{Binding CurrentConversation, Converter={x:Static converters:NotNullToVisibilityConverter.Instance}}">
                     <StackPanel>
                         <TextBlock Text="Conversation Details" FontWeight="Bold" Margin="0,0,0,10"/>
                         <Grid>
                             <Grid.RowDefinitions>
                                 <RowDefinition Height="Auto"/>
                                 <RowDefinition Height="Auto"/>
                                 <RowDefinition Height="Auto"/>
                                 <RowDefinition Height="Auto"/>
                             </Grid.RowDefinitions>
                             <Grid.ColumnDefinitions>
                                 <ColumnDefinition Width="80"/>
                                 <ColumnDefinition Width="*"/>
                             </Grid.ColumnDefinitions>

                             <TextBlock Grid.Row="0" Grid.Column="0" Text="ID:" VerticalAlignment="Center"/>
                             <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding CurrentConversation.Metadata.Id}" Margin="5"/>

                             <TextBlock Grid.Row="1" Grid.Column="0" Text="Name:" VerticalAlignment="Center"/>
                             <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding CurrentConversation.Metadata.Name}" Margin="5"/>

                             <TextBlock Grid.Row="2" Grid.Column="0" Text="Description:" VerticalAlignment="Top" Margin="0,5,0,0"/>
                             <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding CurrentConversation.Metadata.Description}" 
                                      Margin="5" AcceptsReturn="True" Height="60" TextWrapping="Wrap"/>

                             <TextBlock Grid.Row="3" Grid.Column="0" Text="Portrait:" VerticalAlignment="Center"/>
                             <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding CurrentConversation.Metadata.Portrait}" Margin="5"/>
                         </Grid>
                     </StackPanel>
                 </Border>

                 <TextBlock DockPanel.Dock="Top" Text="Conversation Flow" FontWeight="Bold" Margin="10,5"/>
                 
                 <!-- Tree Buttons (Simplified) -->
                 <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="10,5">
                     <Button Command="{Binding AddNodeCommand}"
                             Margin="0,0,3,0"
                             Padding="6,4">
                         <StackPanel Orientation="Horizontal">
                             <TextBlock Text="âž•" FontSize="11" Margin="0,0,2,0"/>
                             <TextBlock Text="{Binding AddNodeButtonText}" VerticalAlignment="Center" FontSize="10"/>
                         </StackPanel>
                     </Button>
                     <Button Command="{Binding DeleteNodeCommand}"
                             Margin="0,0,0,0"
                             Padding="6,4">
                         <StackPanel Orientation="Horizontal">
                             <TextBlock Text="ðŸ—‘ï¸" FontSize="11" Margin="0,0,2,0"/>
                             <TextBlock Text="Delete" VerticalAlignment="Center" FontSize="10"/>
                         </StackPanel>
                     </Button>
                 </StackPanel>

                <!-- Conversation Tree -->
                <TreeView Name="ConversationTreeView" 
                          ItemsSource="{Binding ConversationTree}"
                          SelectedItem="{Binding SelectedNode}"
                          Margin="10,5">
                    <TreeView.ItemTemplate>
                        <TreeDataTemplate ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Converter={x:Static converters:NodeIconConverter.Instance}}" 
                                           FontSize="14" Margin="0,0,5,0"/>
                                <TextBlock Text="{Binding Name}" Margin="2" 
                                           FontWeight="{Binding Converter={x:Static converters:NodeFontWeightConverter.Instance}}"/>
                            </StackPanel>
                        </TreeDataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>
            </DockPanel>
        </Border>

        <!-- Resizable Panel 2 -->
        <GridSplitter Grid.Column="3" 
                       HorizontalAlignment="Stretch" 
                       Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       Width="5"/>

        <!-- Right Panel - Details -->
        <Border Grid.Column="4" Background="{DynamicResource SystemControlBackgroundBaseLowBrush}">
            <ScrollViewer>
                <StackPanel Margin="20">
                                                                                   <TextBlock Text="Node Details" FontSize="20" FontWeight="Bold" Margin="0,0,0,20"/>

                                          <!-- Page Details -->
                     <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                             BorderThickness="1" 
                             CornerRadius="4" 
                             Margin="0,0,0,20" 
                             Padding="10"
                             IsVisible="{Binding SelectedPageNode, Converter={x:Static converters:NotNullToVisibilityConverter.Instance}}">
                                                   <StackPanel>
                              <TextBlock Text="NPC Dialogue" FontWeight="Bold" Margin="0,0,0,10"/>
                              <Grid>
                              <Grid.RowDefinitions>
                                  <RowDefinition Height="Auto"/>
                                  <RowDefinition Height="Auto"/>
                                  <RowDefinition Height="Auto"/>
                              </Grid.RowDefinitions>
                                  <Grid.ColumnDefinitions>
                                      <ColumnDefinition Width="100"/>
                                      <ColumnDefinition Width="*"/>
                                  </Grid.ColumnDefinitions>

                                  <TextBlock Grid.Row="0" Grid.Column="0" Text="NPC Text:" VerticalAlignment="Top" Margin="0,5,0,0"/>
                                  <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding SelectedPageNode.Page.Header}" 
                                           Margin="5" AcceptsReturn="True" Height="120" TextWrapping="Wrap"/>

                                  <TextBlock Grid.Row="1" Grid.Column="0" Text="Page ID:" VerticalAlignment="Center" Margin="0,5,0,0"/>
                                  <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding SelectedPageNode.Page.Id}" Margin="5"/>

                                  <TextBlock Grid.Row="2" Grid.Column="0" Text="Children:" VerticalAlignment="Center" Margin="0,5,0,0"/>
                                  <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedPageNode.Children.Count}" Margin="5,5,5,0"/>
                              </Grid>
                          </StackPanel>
                     </Border>

                                         <!-- Response Details -->
                     <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                             BorderThickness="1" 
                             CornerRadius="4" 
                             Margin="0,0,0,20" 
                             Padding="10"
                             IsVisible="{Binding SelectedResponseNode, Converter={x:Static converters:NotNullToVisibilityConverter.Instance}}">
                         <StackPanel>
                             <TextBlock Text="Player Option" FontWeight="Bold" Margin="0,0,0,10"/>
                             <Grid>
                                 <Grid.RowDefinitions>
                                     <RowDefinition Height="Auto"/>
                                 </Grid.RowDefinitions>
                                 <Grid.ColumnDefinitions>
                                     <ColumnDefinition Width="100"/>
                                     <ColumnDefinition Width="*"/>
                                 </Grid.ColumnDefinitions>

                                                                   <TextBlock Grid.Row="0" Grid.Column="0" Text="Player Text:" VerticalAlignment="Top" Margin="0,5,0,0"/>
                                  <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding SelectedResponseNode.Response.Text}" 
                                           Margin="5" AcceptsReturn="True" Height="120" TextWrapping="Wrap"/>
                             </Grid>
                         </StackPanel>
                     </Border>

                    <!-- Conditions List -->
                    <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                            BorderThickness="1" 
                            CornerRadius="4" 
                            Margin="0,0,0,20" 
                            Padding="10"
                            IsVisible="{Binding SelectedResponseNode, Converter={x:Static converters:NotNullToVisibilityConverter.Instance}}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="200" MinWidth="150"/>
                                <ColumnDefinition Width="5"/>
                                <ColumnDefinition Width="*" MinWidth="200"/>
                            </Grid.ColumnDefinitions>

                            <!-- Left Panel - Conditions List -->
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Conditions" FontWeight="Bold" Margin="0,0,0,10"/>
                                <ListBox ItemsSource="{Binding SelectedResponseNode.Response.Conditions}"
                                         SelectedItem="{Binding SelectedCondition}"
                                         Height="200" Margin="0,5">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding Summary}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                                <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                    <Button Command="{Binding AddConditionCommand}" Content="Add" Margin="0,0,5,0" Padding="8,4"/>
                                    <Button Command="{Binding DeleteConditionCommand}" Content="Delete" Padding="8,4"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- Resizable Panel -->
                            <GridSplitter Grid.Column="1" 
                                         HorizontalAlignment="Stretch" 
                                         Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                         Width="5"/>

                            <!-- Right Panel - Condition Details -->
                            <StackPanel Grid.Column="2" 
                                       IsVisible="{Binding SelectedCondition, Converter={x:Static converters:NotNullToVisibilityConverter.Instance}}"
                                       Margin="10,0,0,0">
                                <TextBlock Text="Condition Details" FontWeight="Bold" Margin="0,0,0,10"/>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Type:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                    <ComboBox Grid.Row="0" Grid.Column="1" SelectedItem="{Binding SelectedCondition.Type, Mode=TwoWay}" Width="180" Margin="5">
                                        <sys:String>PlayerLevel</sys:String>
                                        <sys:String>Variable</sys:String>
                                        <sys:String>PlayerSkill</sys:String>
                                    </ComboBox>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Operator:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                    <ComboBox Grid.Row="1" Grid.Column="1"
                                              ItemsSource="{Binding SelectedCondition.AvailableOperators}"
                                              SelectedItem="{Binding SelectedCondition.Operator, Mode=TwoWay}"
                                              Width="180" Margin="5"/>

                                    <!-- Value (dynamic per type) -->
                                    <!-- PlayerLevel label -->
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Value:" VerticalAlignment="Center" Margin="5,0,0,0"
                                               IsVisible="{Binding SelectedCondition.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=PlayerLevel}"/>
                                    <!-- PlayerLevel numeric -->
                                    <TextBox Grid.Row="2" Grid.Column="1" Margin="5"
                                             IsVisible="{Binding SelectedCondition.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=PlayerLevel}"
                                             Text="{Binding SelectedCondition.NumericValue}"/>
                                    <!-- Variable split into Variable Name and Expected Value -->
                                    <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="5"
                                          IsVisible="{Binding SelectedCondition.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=Variable}">
                                        <Grid.ColumnDefinitions>
                                          <ColumnDefinition Width="Auto"/>
                                          <ColumnDefinition Width="150"/>
                                          <ColumnDefinition Width="10"/>
                                          <ColumnDefinition Width="Auto"/>
                                          <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="Variable Name:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                        <TextBox Grid.Column="1" Text="{Binding SelectedCondition.VariableName}"/>
                                        <TextBlock Grid.Column="3" Text="Value:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                                        <TextBox Grid.Column="4" Text="{Binding SelectedCondition.VariableExpectedValue}"/>
                                    </Grid>
                                    <!-- PlayerSkill: dropdown for skill and numeric input for level -->
                                    <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="5"
                                          IsVisible="{Binding SelectedCondition.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=PlayerSkill}">
                                      <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="180"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                      </Grid.ColumnDefinitions>
                                      <TextBlock Grid.Column="0" Text="Skill:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                      <ComboBox Grid.Column="1" SelectedItem="{Binding SelectedCondition.SkillType, Mode=TwoWay}">
                                        <sys:String>Longsword</sys:String>
                                        <sys:String>GreatSword</sys:String>
                                        <sys:String>Pistol</sys:String>
                                        <sys:String>Dagger</sys:String>
                                        <sys:String>Throwing</sys:String>
                                        <sys:String>GreatAxe</sys:String>
                                        <sys:String>HandToHand</sys:String>
                                        <sys:String>Rifle</sys:String>
                                        <sys:String>Club</sys:String>
                                        <sys:String>Staff</sys:String>
                                        <sys:String>Axe</sys:String>
                                        <sys:String>ShortSword</sys:String>
                                        <sys:String>Polearm</sys:String>
                                        <sys:String>Bow</sys:String>
                                        <sys:String>Weaponcraft</sys:String>
                                        <sys:String>Armorcraft</sys:String>
                                        <sys:String>Fabrication</sys:String>
                                        <sys:String>Synthesis</sys:String>
                                        <sys:String>Engineering</sys:String>
                                        <sys:String>Extraction</sys:String>
                                        <sys:String>Harvesting</sys:String>
                                        <sys:String>Evasion</sys:String>
                                      </ComboBox>
                                      <TextBlock Grid.Column="3" Text="Level:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                                      <TextBox Grid.Column="4" Text="{Binding SelectedCondition.SkillLevelNumeric, Mode=TwoWay}"/>
                                    </Grid>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </Border>

                                                                                   <!-- Actions List -->
                      <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                              BorderThickness="1" 
                              CornerRadius="4" 
                              Margin="0,0,0,20" 
                              Padding="10"
                              IsVisible="{Binding SelectedResponseNode, Converter={x:Static converters:NotNullToVisibilityConverter.Instance}}">
                          <Grid>
                              <Grid.ColumnDefinitions>
                                  <ColumnDefinition Width="200" MinWidth="150"/>
                                  <ColumnDefinition Width="5"/>
                                  <ColumnDefinition Width="*" MinWidth="200"/>
                              </Grid.ColumnDefinitions>
                              
                                                             <!-- Left Panel - Actions List -->
                               <StackPanel Grid.Column="0">
                                   <TextBlock Text="Actions" FontWeight="Bold" Margin="0,0,0,10"/>
                                                                      <ItemsControl ItemsSource="{Binding SelectedResponseNode.Response.Actions}" 
                                                Height="200" Margin="0,5"
                                                Name="ActionsItemsControl">
                                       <ItemsControl.ItemTemplate>
                                           <DataTemplate>
                                               <Border x:Name="ActionBorder"
                                                       BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                                                       BorderThickness="1" 
                                                       CornerRadius="2" 
                                                       Padding="8" 
                                                       Margin="0,2"
                                                       Background="Transparent"
                                                       PointerPressed="OnActionItemClicked"
                                                       Cursor="Hand">
                                                   <Border.Styles>
                                                       <Style Selector="Border:pointerover">
                                                           <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundListLowBrush}"/>
                                                       </Style>
                                                   </Border.Styles>
                                                   <Grid>
                                                       <Grid.ColumnDefinitions>
                                                           <ColumnDefinition Width="*"/>
                                                           <ColumnDefinition Width="Auto"/>
                                                       </Grid.ColumnDefinitions>
                                                       <StackPanel Grid.Column="0">
                                                           <TextBlock Text="{Binding Type}" FontWeight="Bold" Margin="0,0,0,2"/>
                                                           <TextBlock Text="{Binding Converter={x:Static converters:ActionSummaryConverter.Instance}}" 
                                                                      FontSize="10" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                                       </StackPanel>
                                                       <StackPanel Grid.Column="1" Orientation="Vertical" Margin="5,0,0,0">
                                                           <Button x:Name="MoveUpButton"
                                                                   Click="OnMoveActionUp" 
                                                                   Tag="{Binding}" 
                                                                   Padding="4,2" 
                                                                   Margin="0,0,0,1" 
                                                                   FontSize="12">
                                                               <TextBlock Text="ðŸ”º" />
                                                               <ToolTip.Tip>Move Up</ToolTip.Tip>
                                                           </Button>
                                                           <Button x:Name="MoveDownButton"
                                                                   Click="OnMoveActionDown" 
                                                                   Tag="{Binding}" 
                                                                   Padding="4,2" 
                                                                   FontSize="12">
                                                               <TextBlock Text="ðŸ”»" />
                                                               <ToolTip.Tip>Move Down</ToolTip.Tip>
                                                           </Button>
                                                       </StackPanel>
                                                   </Grid>
                                               </Border>
                                           </DataTemplate>
                                       </ItemsControl.ItemTemplate>
                                   </ItemsControl>
                                   <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                       <Button Command="{Binding AddActionCommand}" Content="Add" Margin="0,0,5,0" Padding="8,4"/>
                                       <Button Command="{Binding DeleteActionCommand}" Content="Delete" Padding="8,4"/>
                                   </StackPanel>
                               </StackPanel>
                              
                              <!-- Resizable Panel -->
                              <GridSplitter Grid.Column="1" 
                                           HorizontalAlignment="Stretch" 
                                           Background="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                           Width="5"/>
                              
                              <!-- Right Panel - Action Details -->
                              <StackPanel Grid.Column="2" 
                                         IsVisible="{Binding SelectedAction, Converter={x:Static converters:NotNullToVisibilityConverter.Instance}}"
                                         Margin="10,0,0,0">
                                  <TextBlock Text="Action Details" FontWeight="Bold" Margin="0,0,0,10"/>
                                  <Grid>
                                      <Grid.RowDefinitions>
                                          <RowDefinition Height="Auto"/>
                                          <RowDefinition Height="Auto"/>
                                      </Grid.RowDefinitions>
                                      <Grid.ColumnDefinitions>
                                          <ColumnDefinition Width="100"/>
                                          <ColumnDefinition Width="*"/>
                                      </Grid.ColumnDefinitions>

                                      <TextBlock Grid.Row="0" Grid.Column="0" Text="Type:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                      <ComboBox Grid.Row="0" Grid.Column="1" SelectedItem="{Binding SelectedAction.Type}" Margin="5" HorizontalAlignment="Stretch" MinWidth="220">
                                          <sys:String>ChangePage</sys:String>
                                          <sys:String>OpenShop</sys:String>
                                          <sys:String>GiveItem</sys:String>
                                          <sys:String>StartQuest</sys:String>
                                          <sys:String>Teleport</sys:String>
                                          <sys:String>ExecuteScript</sys:String>
                                          <sys:String>EndConversation</sys:String>
                                      </ComboBox>

                                      <!-- Action Parameters -->
                                      <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                              Margin="0,10,0,0">
                                          <Grid>
                                              <Grid.ColumnDefinitions>
                                                  <ColumnDefinition Width="100"/>
                                                  <ColumnDefinition Width="*"/>
                                              </Grid.ColumnDefinitions>
                                              
                                              <!-- ChangePage Parameters -->
                                              <StackPanel Grid.Column="0" Grid.ColumnSpan="2" 
                                                          IsVisible="{Binding SelectedAction.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=ChangePage}">
                                                  <Grid>
                                                      <Grid.ColumnDefinitions>
                                                          <ColumnDefinition Width="100"/>
                                                          <ColumnDefinition Width="*"/>
                                                      </Grid.ColumnDefinitions>
                                                      <TextBlock Grid.Column="0" Text="Page:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                      <ComboBox Grid.Column="1" Margin="5"
                                                                ItemsSource="{Binding AvailablePageIds}"
                                                                SelectedItem="{Binding SelectedChangePageItem, Mode=TwoWay}"/>
                                                  </Grid>
                                              </StackPanel>

                                              <!-- OpenShop Parameters -->
                                              <StackPanel Grid.Column="0" Grid.ColumnSpan="2" 
                                                          IsVisible="{Binding SelectedAction.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=OpenShop}">
                                                  <Grid>
                                                      <Grid.ColumnDefinitions>
                                                          <ColumnDefinition Width="100"/>
                                                          <ColumnDefinition Width="*"/>
                                                      </Grid.ColumnDefinitions>
                                                      <TextBlock Grid.Column="0" Text="Shop ID:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                      <TextBox Grid.Column="1" Text="{Binding SelectedAction.ShopId}" Margin="5"/>
                                                  </Grid>
                                              </StackPanel>
                                              
                                              <!-- GiveItem Parameters -->
                                              <StackPanel Grid.Column="0" Grid.ColumnSpan="2" 
                                                          IsVisible="{Binding SelectedAction.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=GiveItem}">
                                                  <Grid>
                                                      <Grid.RowDefinitions>
                                                          <RowDefinition Height="Auto"/>
                                                          <RowDefinition Height="Auto"/>
                                                      </Grid.RowDefinitions>
                                                      <Grid.ColumnDefinitions>
                                                          <ColumnDefinition Width="100"/>
                                                          <ColumnDefinition Width="*"/>
                                                      </Grid.ColumnDefinitions>
                                                                                                             <TextBlock Grid.Row="0" Grid.Column="0" Text="Resref:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                       <StackPanel Grid.Row="0" Grid.Column="1">
                                                           <TextBox Text="{Binding SelectedAction.ItemId}" Margin="5" MaxLength="16"/>
                                                           <TextBlock Text="{Binding SelectedAction.ItemId, Converter={x:Static converters:StringLengthConverter.Instance}}" 
                                                                      FontSize="10" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                                                                      HorizontalAlignment="Right" Margin="5,0,5,0"/>
                                                       </StackPanel>
                                                                                                             <TextBlock Grid.Row="1" Grid.Column="0" Text="Quantity:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                       <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding SelectedAction.Quantity}" Margin="5" 
                                                                InputMethod.IsInputMethodEnabled="False" 
                                                                KeyDown="OnQuantityKeyDown"/>
                                                  </Grid>
                                              </StackPanel>
                                              
                                              <!-- StartQuest Parameters -->
                                              <StackPanel Grid.Column="0" Grid.ColumnSpan="2" 
                                                          IsVisible="{Binding SelectedAction.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=StartQuest}">
                                                  <Grid>
                                                      <Grid.ColumnDefinitions>
                                                          <ColumnDefinition Width="100"/>
                                                          <ColumnDefinition Width="*"/>
                                                      </Grid.ColumnDefinitions>
                                                      <TextBlock Grid.Column="0" Text="Quest ID:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                      <TextBox Grid.Column="1" Text="{Binding SelectedAction.QuestId}" Margin="5"/>
                                                  </Grid>
                                              </StackPanel>

                                               <!-- Teleport Parameters -->
                                               <StackPanel Grid.Column="0" Grid.ColumnSpan="2" 
                                                           IsVisible="{Binding SelectedAction.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=Teleport}">
                                                   <Grid>
                                                       <Grid.ColumnDefinitions>
                                                           <ColumnDefinition Width="100"/>
                                                           <ColumnDefinition Width="*"/>
                                                       </Grid.ColumnDefinitions>
                                                       <TextBlock Grid.Column="0" Text="Tag:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                       <TextBox Grid.Column="1" Text="{Binding SelectedAction.Tag}" Margin="5" MaxLength="32"/>
                                                   </Grid>
                                               </StackPanel>

                                               <!-- ExecuteScript Parameters -->
                                               <StackPanel Grid.Column="0" Grid.ColumnSpan="2" 
                                                           IsVisible="{Binding SelectedAction.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=ExecuteScript}">
                                                   <Grid>
                                                       <Grid.ColumnDefinitions>
                                                           <ColumnDefinition Width="100"/>
                                                           <ColumnDefinition Width="*"/>
                                                       </Grid.ColumnDefinitions>
                                                       <TextBlock Grid.Column="0" Text="Script ID:" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                       <TextBox Grid.Column="1" Text="{Binding SelectedAction.ScriptId}" Margin="5"/>
                                                   </Grid>
                                               </StackPanel>

                                              <!-- EndConversation has no parameters -->
                                              <StackPanel Grid.Column="0" Grid.ColumnSpan="2"
                                                          IsVisible="{Binding SelectedAction.Type, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=EndConversation}">
                                                  <TextBlock Text="No parameters" Margin="5"/>
                                              </StackPanel>
                                          </Grid>
                                      </Border>
                                  </Grid>
                              </StackPanel>
                          </Grid>
                      </Border>

                                         <!-- Save Button -->
                     <Button Command="{Binding SaveConversationCommand}" 
                             HorizontalAlignment="Right"
                             Padding="20,10"
                             IsVisible="{Binding SelectedNode, Converter={x:Static converters:NotNullToVisibilityConverter.Instance}}">
                         <StackPanel Orientation="Horizontal">
                             <TextBlock Text="ðŸ’¾" FontSize="16" Margin="0,0,5,0"/>
                             <TextBlock Text="Save Conversation" VerticalAlignment="Center"/>
                         </StackPanel>
                     </Button>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>

</UserControl>
